# 🚩 開発プロセス詳細ログ (Development Log)

このドキュメントは、本プロジェクトの構築過程をブログ記事として昇華させるための詳細な記録です。

## ステップ 1: 環境構築とベースライン (2026-02-22)

- **Vite の採用**: 高速な HMR (Hot Module Replacement) により、物理演算の微調整をリアルタイムで行える環境を構築。
- **Stable Fluids 実装**: Jos Stam 氏の論文に基づき、移流 (Advection)・拡散 (Diffusion)・投影 (Projection) の 3 ステップを JS クラスとして独立させた。

## ステップ 2: パフォーマンスの壁と最適化

- **問題点**: 最初、描画毎に `createElement('canvas')` を行っていたため、FPS が 5 未満に低下。
- **改善**: メモリリークを防ぐため、**オフスクリーン Canvas** を 1 つだけ生成し、`putImageData` でバッファを更新する設計に変更。これにより 60FPS を達成。
- **アルゴリズム修正**: 解像度を変更した際に配列サイズが不整合になるバグを特定。また、高解像度（256など）では計算領域が広がるため、同じ「物理的な力」でもグリッドに対する相対的な影響が弱まる現象を確認。計算エンジンの反復回数を 20 回から 40 回に増やし、注入量を動的にスケーリングすることで、どの解像度でも安定した川の流れを実現した。

## ステップ 3: 物理挙動の洗練（デバッグ記録）

- **垂直勾配の謎**: 流体が片方に寄る現象が発生。コード精査の結果、速度補正 (Projection) 時の Y 方向インデックス計算にタイポ (`i-1` とすべき所が `j-1`) を発見し修正。
- **境界条件**: 壁（画面端）と「石（障害物）」で物理法則が異なるため、カスタム境界ハンドラ `set_custom_bnd` を導入し、自然な反射を実現。

## ステップ 4: 視覚的なプレミアム化

- **描画ロジック**: 黒い画面（初期状態）の不安を解消するため、ベースラインの背景色補間を導入。密度 0 でも「シミュレート中であること」を暗に伝える UI へ。
- **カラーパレット**: 科学的な見た目よりも、モダンな「水っぽさ」を優先し、Deep Blue から Cyan への色調へ調整。

## ステップ 5: 「川」としての完成 (2026-02-22)

- **定常流の実装**: 画面上端（グリッドの 1 行目）に対して、毎フレーム一定の密度と下方向の速度を注入し続けることで、常に上から下に流れる「川」の状態を作り出した。
- **動的なパラメータ調整**: 解像度 (N) に応じて注入量や流速をスケーリングし、256x256 でも下流まで水が届く「力強さ」を持たせた。
- **直感的な操作系**: 「どのアクションで石を置けるのか分からない」という課題に対し、明確な **BRUSH MODE (Water/Stone)** 切り替えボタンを UI に追加。
- **視覚性と当たり判定**: 1ピクセルでは見づらかった石を、3x3 のブロックとして配置するように変更。色調も明るいグレーに調整し、シミュレーション内での存在感を強調した。

- ✨ **「なぜ Rust を目指すのか？」**: 現状の JS でも十分動くが、解像度を 512x512 以上に上げた瞬間に計算負荷が爆発する。この「極限」を突破するための Rust (Wasm) というストーリー。
- ✨ **「失敗こそが最強のコンテンツ」**: 描画ミスや計算ミスをどうやって特定したか（FPS カウンターの動き、流体の偏り）を画像付きで語る。
